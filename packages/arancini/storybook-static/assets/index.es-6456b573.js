var j=Object.defineProperty;var C=(o,e,t)=>e in o?j(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var r=(o,e,t)=>(C(o,typeof e!="symbol"?e+"":e,t),t);import{r as R}from"./index-76fb7be0.js";var x={exports:{}},m={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var P=R,M=Symbol.for("react.element"),O=Symbol.for("react.fragment"),U=Object.prototype.hasOwnProperty,I=P.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Q={key:!0,ref:!0,__self:!0,__source:!0};function k(o,e,t){var s,i={},n=null,h=null;t!==void 0&&(n=""+t),e.key!==void 0&&(n=""+e.key),e.ref!==void 0&&(h=e.ref);for(s in e)U.call(e,s)&&!Q.hasOwnProperty(s)&&(i[s]=e[s]);if(o&&o.defaultProps)for(s in e=o.defaultProps,e)i[s]===void 0&&(i[s]=e[s]);return{$$typeof:M,type:o,key:n,ref:h,props:i,_owner:I.current}}m.Fragment=O;m.jsx=k;m.jsxs=k;x.exports=m;var S=x.exports;const L=S.Fragment,B=S.jsx,J=S.jsxs;class E{constructor(){r(this,"listeners",new Set)}add(e){return this.listeners.add(e),()=>this.remove(e)}remove(e){this.listeners.delete(e)}emit(...e){for(const t of this.listeners)t(...e)}clear(){this.listeners.clear()}}class A{constructor(){r(this,"entities",[]);r(this,"version",0);r(this,"onEntityAdded",new E);r(this,"onEntityRemoved",new E);r(this,"_entityPositions",new Map);r(this,"_entitySet",new Set)}get first(){return this.entities[0]||void 0}[Symbol.iterator](){let e=this.entities.length;const t={value:void 0,done:!1};return{next:()=>(t.value=this.entities[--e],t.done=e<0,t)}}has(e){return this._entitySet.has(e)}}const f=(o,e)=>{e&&!o.has(e)&&(o.entities.push(e),o._entityPositions.set(e,o.entities.length-1),o._entitySet.add(e),o.version++,o.onEntityAdded.emit(e))},g=(o,e)=>{if(!o.has(e))return;const t=o._entityPositions.get(e);o._entityPositions.delete(e),o._entitySet.delete(e);const s=o.entities[o.entities.length-1];s!==e&&(o.entities[t]=s,o._entityPositions.set(s,t)),o.entities.pop(),o.version++,o.onEntityRemoved.emit(e)};class z{constructor(e,t){r(this,"availableObjects",[]);r(this,"factory");r(this,"size",0);this.factory=e,t!==void 0&&this.grow(t)}get available(){return this.availableObjects.length}get used(){return this.size-this.availableObjects.length}grow(e){for(let t=0;t<e;t++)this.availableObjects.push(this.factory());this.size+=e}free(e){for(let t=0;t<e&&this.availableObjects.pop();t++)this.size--}request(){return this.availableObjects.length<=0&&this.grow(Math.round(.2*this.size)+1),this.availableObjects.pop()}recycle(e){this.availableObjects.push(e),this.availableObjects.length>Math.round(.2*this.size)&&this.free(this.availableObjects.length-Math.round(.2*this.size))}}class p{constructor(e=[]){r(this,"words");this.words=new Uint32Array(1);for(const t of e)this.add(t)}add(...e){for(let t=0;t<e.length;t++){const s=e[t];this.resize(s),this.words[s>>>5]|=1<<s}}remove(...e){for(let t=0;t<e.length;t++){const s=e[t];this.resize(s),this.words[s>>>5]&=~(1<<s)}}has(e){return(this.words[e>>>5]&1<<e)!=0}resize(e){if(this.words.length<<5>e)return;const t=new Uint32Array(e+32>>>5<<1);t.set(this.words),this.words=t}reset(){for(let e=0;e<this.words.length;e++)this.words[e]=0}copy(e){const t=new Uint32Array(e.words.length);t.set(e.words),this.words=t}clone(){const e=new Uint32Array(this.words.length);e.set(this.words);const t=new p;return t.words=e,t}containsAll(e){for(let t=0;t<this.words.length;t++)if(~this.words[t]&e.words[t])return!1;return!0}containsAny(e){for(let t=0;t<this.words.length;t++)if(this.words[t]&e.words[t])return!0;return!1}}const y=Symbol("__arancini");class T extends A{constructor(t,s,i,n){super();r(this,"world");r(this,"key");r(this,"conditions");r(this,"bitSets");this.world=t,this.key=s,this.conditions=i,this.bitSets=n}destroy(){this.world.destroyQuery(this)}}const q=(o,e)=>{const t=[];for(const s of e)v(o,s)&&t.push(s);return t},v=(o,e)=>{const t=e;for(const s of o)if(s.type==="all"&&!t[y].bitset.containsAll(s.bitset)||s.type==="any"&&!t[y].bitset.containsAny(s.bitset)||s.type==="not"&&t[y].bitset.containsAny(s.bitset))return!1;return!0},w=o=>{const e=new $;o(e);const t=e.conditions;if(t.length<=0)throw new Error("Query must have at least one condition");if(t.some(n=>n.components.length<=0))throw new Error("Query conditions must have at least one component");const s={type:"all",components:[]},i=[];for(const n of t)n.type==="all"?s.components.push(...n.components):i.push(n);return[s,...i]},_=(o,e)=>e.map(({type:t,components:s})=>t==="all"?s.map(i=>o[i]).sort().join(","):[`${t}:${s.map(i=>o[i]).sort().join(",")}`]).sort().join("&"),b=(o,e)=>e.map(t=>({type:t.type,bitset:new p(t.components.map(s=>o[s]))}));class ${constructor(){r(this,"T");r(this,"conditions",[]);r(this,"all",(...e)=>(this.conditions.push({type:"all",components:e}),this));r(this,"any",(...e)=>(this.conditions.push({type:"any",components:e}),this));r(this,"not",(...e)=>(this.conditions.push({type:"not",components:e}),this));r(this,"with",this.all);r(this,"have",this.all);r(this,"has",this.all);r(this,"every",this.all);r(this,"is",this.all);r(this,"some",this.any);r(this,"one",this.any);r(this,"none",this.not);r(this,"without",this.not)}get and(){return this}get but(){return this}get where(){return this}get are(){return this}}class W{constructor(e){r(this,"enabled",!0);r(this,"world");r(this,"__internal",{class:null,queries:new Set,priority:0,order:0,requiredQueries:[]});this.world=e}onDestroy(){}onInit(){}onUpdate(e,t){}unregister(){this.world.unregisterSystem(this.__internal.class)}query(e,t){return this.world.systemManager.createSystemQuery(this,e,t)}singleton(e,t){return{__internal:{systemSingletonPlaceholder:!0,component:e,options:t}}}attach(e){return{__internal:{attachedSystemPlaceholder:!0,systemClass:e}}}}class D{constructor(e){r(this,"systems",new Map);r(this,"sortedSystems",[]);r(this,"systemCounter",0);r(this,"systemAttachments",new Map);r(this,"world");this.world=e}init(){for(const e of this.systems.values())this.initSystem(e);this.sortSystems()}update(e,t){for(let s=0;s<this.sortedSystems.length;s++){const i=this.sortedSystems[s];i.enabled&&(i.__internal.requiredQueries.length>0&&i.__internal.requiredQueries.some(n=>n.entities.length===0)||i.onUpdate(e,t))}}destroy(){for(const e of this.systems.values())e.onDestroy()}registerSystem(e,t){if(this.systems.has(e))throw new Error(`System "${e.name}" has already been registered`);this.systemCounter++;const s=new e(this.world);this.systems.set(e,s),s.__internal.class=e,s.__internal.priority=(t==null?void 0:t.priority)??0,s.__internal.order=this.systemCounter,this.initSingletonQueries(s),this.updateAllSystemAttachments();const i=(n=e,h="onUpdate",Object.getOwnPropertyNames(n.prototype).includes(h));var n,h;i&&this.sortedSystems.push(s),this.world.initialised&&(this.initSystem(s),i&&this.sortSystems())}unregisterSystem(e){const t=this.systems.get(e);t&&(this.systems.delete(e),this.sortedSystems=this.sortedSystems.filter(s=>s.__internal.class!==e),t.__internal.queries.forEach(s=>{this.world.destroyQuery(s,t)}),t.__internal.requiredQueries=[],t.onDestroy(),this.updateAllSystemAttachments())}createSystemQuery(e,t,s){const i=this.world.query(t,{owner:e});return s!=null&&s.required&&e.__internal.requiredQueries.push(i),i}initSystem(e){e.onInit()}initSingletonQueries(e){var t;for(const s in e){const i=e,n=i[s];if((t=n==null?void 0:n.__internal)!=null&&t.systemSingletonPlaceholder){const{__internal:{component:h,options:a}}=n,l=u=>u.has(h),d=this.createSystemQuery(e,l,a),c=()=>{var u;i[s]=(u=d.first)==null?void 0:u[h]};d.onEntityAdded.add(c),d.onEntityRemoved.add(c),c()}}}updateSystemAttachments(e){var s;for(const i in e){const n=e[i];if((s=n==null?void 0:n.__internal)!=null&&s.attachedSystemPlaceholder){const h=this.systemAttachments.get(e)??[];h.push({field:i,systemClass:n.__internal.systemClass}),this.systemAttachments.set(e,h);const{__internal:{systemClass:a}}=n;e[i]=this.world.getSystem(a)}}const t=this.systemAttachments.get(e)??[];for(const{field:i,systemClass:n}of t)e[i]=this.world.getSystem(n)}updateAllSystemAttachments(){for(const e of this.systems.values())this.updateSystemAttachments(e)}sortSystems(){this.sortedSystems.sort((e,t)=>t.__internal.priority-e.__internal.priority||e.__internal.order-t.__internal.order)}}class Y extends A{constructor(t){super();r(this,"time",0);r(this,"initialised",!1);r(this,"systemManager");r(this,"queries",new Map);r(this,"queryConsumers",new Map);r(this,"componentIndexCounter",-1);r(this,"componentRegistry",{});r(this,"idToEntity",new Map);r(this,"entityIdCounter",0);r(this,"bulkUpdateInProgress",!1);r(this,"bulkUpdateEntities",new Set);r(this,"entityMetadataPool",new z(()=>({bitset:new p,id:void 0})));this.systemManager=new D(this),t!=null&&t.components&&this.registerComponents(t.components)}init(){this.initialised=!0,this.systemManager.init()}step(t){this.time+=t,this.systemManager.update(t,this.time)}reset(){this.time=0,this.initialised=!1,this.systemManager.destroy(),this.entities.forEach(t=>this.destroy(t)),this.entityIdCounter=0,this.idToEntity.clear(),this._entityPositions.clear()}id(t){if(!this.has(t))return;const s=t[y];let i=s.id;return i===void 0&&(i=this.entityIdCounter++,s.id=i,this.idToEntity.set(i,t)),i}entity(t){return this.idToEntity.get(t)}create(t){f(this,t);const s=this.entityMetadataPool.request();return s.bitset.add(...Object.keys(t).map(i=>this.componentRegistry[i])),t[y]=s,this.index(t),t}destroy(t){g(this,t),this.queries.forEach(n=>g(n,t));const s=t[y];delete t[y];let i=s.id;i!==void 0&&(this.idToEntity.delete(i),s.id=void 0),s.bitset.reset(),this.entityMetadataPool.recycle(s)}add(t,s,i){return t[s]!==void 0?this:(t[s]=i,t[y].bitset.add(this.componentRegistry[s]),this.index(t),this)}remove(t,s){t[s]!==void 0&&(this.has(t)&&(t[y].bitset.remove(this.componentRegistry[s]),this.index(t)),delete t[s])}update(t,s){if(typeof s=="function"){const i=s,n=new Proxy(t,{set:(h,a,l)=>{const d=a,c=d in t;return c&&l===void 0?this.remove(t,d):c?Reflect.set(t,a,l):this.add(t,d,l),!0},deleteProperty:(h,a)=>(this.remove(t,a),!0)});this.bulk(()=>{i(n)})}else{const i=s;this.bulk(()=>{for(const n in i){const h=i[n];h!==void 0?this.add(t,n,h):this.remove(t,n)}})}}bulk(t){this.bulkUpdateInProgress=!0,t(),this.bulkUpdateInProgress=!1;for(const s of this.bulkUpdateEntities)this.index(s);this.bulkUpdateEntities.clear()}query(t,s){const i=w(t),n=_(this.componentRegistry,i);let h=this.queries.get(n);if(h)return h;h=new T(this,n,i,b(this.componentRegistry,i));const a=q(h.bitSets,this.entities.values());for(const c of a)f(h,c);this.queries.set(n,h);const l=(s==null?void 0:s.owner)??"standalone",d=this.queryConsumers.get(h.key)??[];return d.push(l),this.queryConsumers.set(h.key,d),h}destroyQuery(t,s="standalone"){if(!this.queries.has(t.key))return;let i=this.queryConsumers.get(t.key)??[];i=i.filter(n=>n!==s),i.length>0?this.queryConsumers.set(t.key,i):(this.queries.delete(t.key),this.queryConsumers.delete(t.key),t.onEntityAdded.clear(),t.onEntityRemoved.clear())}filter(t){const s=w(t),i=_(this.componentRegistry,s),n=this.queries.get(i);if(n)return n.entities;const h=b(this.componentRegistry,s);return q(h,this.entities)}find(t){const s=w(t),i=_(this.componentRegistry,s),n=this.queries.get(i);return n?n.first:((h,a)=>{for(const l of a)if(v(h,l))return l})(b(this.componentRegistry,s),this.entities)}registerComponents(t){for(const s of t)this.componentRegistry[s]===void 0&&(this.componentIndexCounter++,this.componentRegistry[s]=this.componentIndexCounter);if(this.initialised)for(const s of this.entities.values())s[y].bitset.resize(this.componentIndexCounter)}registerSystem(t,s){return this.systemManager.registerSystem(t,s),this}unregisterSystem(t){return this.systemManager.unregisterSystem(t),this}getSystem(t){return this.systemManager.systems.get(t)}getSystems(){return Array.from(this.systemManager.systems.values())}index(t){if(this.has(t))if(this.bulkUpdateInProgress)this.bulkUpdateEntities.add(t);else for(const s of this.queries.values()){const i=v(s.bitSets,t),n=s.has(t);i&&!n?f(s,t):!i&&n&&g(s,t)}}}export{L as F,J as a,Y as g,T as h,B as j,W as m};
